---
title: "Introduction to Jellyfisher"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to Jellyfisher}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(jellyfisher)
```

```{r echo=F, message=F}
# Subset the data to keep the compiled vignette a bit smaller
jellyfisher_example_tables <- jellyfisher_example_tables |>
  filter_tables(c("EOC69", "EOC677", "EOC495", "EOC809"))
```

**Jellyfisher** is an R package for visualizing tumor evolution and subclonal
compositions using Jellyfish plots. The package is based on the
[Jellyfish](https://github.com/HautaniemiLab/jellyfish) visualization tool,
bringing its functionality to R users. Jellyfisher supports both
[ClonEvol](https://github.com/hdng/clonevol) results and plain data frames,
making it compatible with various tools and workflows.

## Input data

The input data should follow specific structures for _samples_, _phylogeny_, and
subclonal _compositions_. The Jellyfisher package comes with a sample data set.

### Samples
            
- `sample` (string): specifies the unique identifier for each sample.
- `displayName` (string, optional): allows for specifying a custom name for each sample. If the column is omitted, the `sample` column is used as the display name.
- `rank` (integer): specifies the position of each sample in the Jellyfish plot. For example, different stages of a disease can be ranked in chronological order: diagnosis (1), interval (2), and relapse (3). The zeroth rank is reserved for the root of the sample tree. Ranks can be any integer, and unused ranks are automatically excluded from the plot. If the `rank` column is
  absent, ranks are assigned based on each sampleâ€™s depth in the sample tree.
- `parent` (string): identifies the parent sample for each entry. Samples without a specified parent are treated as children of an imaginary root sample.

```{r}
head(jellyfisher_example_tables$samples, 25)
```

### Phylogeny

- `subclone` (string): specifies subclone IDs, which can be any string.
- `parent` (string): designates the parent subclone. The subclone without a parent is considered the root of the phylogeny.
- `color` (string, optional): specifies the color for the subclone. If the column is omitted, colors will be generated automatically.
- `branchLength` (number): specifies the length of the branch leading to the subclone. The length may be based on, for example, the number of unique mutations in the subclone. The branch length is shown in the Jellyfish plot's legend as a bar chart. It is also used when generating a phylogeny-aware color scheme.

```{r}
head(jellyfisher_example_tables$phylogeny, 25)
```

### Subclonal compositions

Subclonal compositions are specified in a
[tidy](https://vita.had.co.nz/papers/tidy-data.pdf) format, where each row
represents a subclone in a sample.

- `sample` (string): specifies the sample ID.
- `subclone` (string): specifies the subclone ID.
- `clonalPrevalence` (number): specifies the clonal prevalence of the subclone in the sample. The clonal prevalence is the proportion of the subclone in the sample. The clonal prevalences in a sample must sum to 1.

```{r}
head(jellyfisher_example_tables$compositions, 25)
```

## Plotting

### Basic plotting 

The three tables are passed to the `jellyfisher` function as a named list. The
function generates an interactive Jellyfish plot based on the input data.

```{r}
jellyfisher(jellyfisher_example_tables,
            width = "100%", height = 500)
```

### Plotting with custom options

```{r}
jellyfisher(jellyfisher_example_tables,
            options = list(
              sampleHeight = 70,
              sampleTakenGuide = "none",
              showLegend = FALSE
            ),
            width = "100%", height = 500)
```

### Plotting a single patient

When plotting multiple patients, Jellyfisher shows buttons (Previous and Next)
to navigate between patients. When the data contains only one patient, these
buttons are hidden. The package also provides a `filter_tables` function to
select a specific patient with ease.

```{r}
jellyfisher_example_tables |>
  filter_tables(patient = "EOC677") |>
  jellyfisher(width = "100%", height = 500)
```

### Adjusting the sample tree structures

The sample trees in the example data set were constructed as follows:

*"For each sample, we checked whether an earlier time point included exactly one
sample from the same anatomical location.  If such a sample existed, it was
assigned as the parent; otherwise, the inferred root was used as the parent."*

However, the *r1Bow1* (bowel) sample in the following jellyfish plot is derived
from an earlier bowel sample *p2Bow1_c*, which has no traces of the subclone 12.

```{r}
jellyfisher_example_tables |>
  filter_tables("EOC809") |>
  jellyfisher(width = "100%", height = 600)
```

Using the `set_parents` function, we can adjust the parent of the *r1Bow1* sample
to be *p2Per1_cO* (peritoneum), which is a possible source of the metastasis due
to its proximity. The high prevalence of subclone 12 in this sample suggests
that it is the likely source of the metastasis in the *r1Bow1* sample.

```{r}
jellyfisher_example_tables |>
  filter_tables("EOC809") |>
  set_parents(list("EOC809_r1Bow1_DNA1" = "EOC809_p2Per1_cO_DNA2")) |>
  jellyfisher(width = "100%", height = 600)
```

## Session info

```{r}
sessionInfo()
```